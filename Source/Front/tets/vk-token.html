<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Обработка токена VK</title>
</head>
<body>
    <script>
        // Обработка токена от VK OAuth
        const authPageOrigin = window.location.origin;
        const API_URL = window.location.origin + '/api';
        
        // Проверяем, есть ли код авторизации в URL (Authorization Code Flow - VK ID SDK)
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        
        if (code) {
            // Authorization Code Flow - код нужно обменять на токен на бэкенде
            console.log('Получен код авторизации от VK ID SDK');
            exchangeVKCodeForToken(code);
        } else if (error) {
            // Обработка ошибки
            console.error('VK OAuth Error:', error, urlParams.get('error_description'));
            localStorage.setItem('vk_oauth_error', error);
            localStorage.setItem('vk_oauth_error_description', urlParams.get('error_description') || '');
            window.location.href = authPageOrigin + '/tets/login.html';
        } else {
            // Проверяем, есть ли токен в URL hash (Implicit Flow - fallback)
            const hash = window.location.hash;
            if (hash && hash.includes('access_token=')) {
                // Извлекаем токен из hash
                const params = new URLSearchParams(hash.substring(1));
                const accessToken = params.get('access_token');
                
                if (accessToken) {
                    console.log('Токен получен от VK (Implicit Flow):', accessToken.substring(0, 20) + '...');
                    
                    // Сохраняем токен в localStorage для передачи на страницу авторизации
                    localStorage.setItem('vk_oauth_token', accessToken);
                    localStorage.setItem('vk_oauth_expires_in', params.get('expires_in') || '');
                    localStorage.setItem('vk_oauth_user_id', params.get('user_id') || '');
                    
                    // Перенаправляем на страницу авторизации
                    window.location.href = authPageOrigin + '/tets/login.html';
                } else {
                    // Если токена нет, проверяем ошибку
                    const error = params.get('error');
                    const errorDescription = params.get('error_description');
                    if (error) {
                        console.error('VK OAuth Error:', error, errorDescription);
                        localStorage.setItem('vk_oauth_error', error);
                        localStorage.setItem('vk_oauth_error_description', errorDescription || '');
                    }
                    window.location.href = authPageOrigin + '/tets/login.html';
                }
            } else {
                // Если ничего нет, перенаправляем на страницу авторизации
                window.location.href = authPageOrigin + '/tets/login.html';
            }
        }
        
        // Функция для обмена кода на токен через бэкенд
        async function exchangeVKCodeForToken(code) {
            try {
                const response = await fetch(`${API_URL}/auth/oauth/exchange-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: 'vk',
                        code: code,
                        redirect_uri: window.location.origin + '/tets/vk-token.html'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.access_token) {
                    console.log('Токен получен от бэкенда');
                    // Сохраняем токен в localStorage
                    localStorage.setItem('vk_oauth_token', data.access_token);
                    localStorage.setItem('vk_oauth_expires_in', data.expires_in || '');
                    localStorage.setItem('vk_oauth_user_id', data.user_id || '');
                    // Перенаправляем на страницу авторизации
                    window.location.href = authPageOrigin + '/tets/login.html';
                } else {
                    console.error('Ошибка обмена кода на токен:', data);
                    localStorage.setItem('vk_oauth_error', data.detail || 'Ошибка обмена кода на токен');
                    window.location.href = authPageOrigin + '/tets/login.html';
                }
            } catch (error) {
                console.error('Ошибка запроса обмена кода:', error);
                localStorage.setItem('vk_oauth_error', 'Ошибка соединения с сервером');
                window.location.href = authPageOrigin + '/tets/login.html';
            }
        }
    </script>
</body>
</html>

