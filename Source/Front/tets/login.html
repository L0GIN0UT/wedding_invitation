<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ - –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
    <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 450px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .code-input {
            display: flex;
            gap: 10px;
        }

        .code-input input {
            flex: 1;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .oauth-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤ */
        #vk-id-widget,
        #yandex-id-widget {
            width: 100%;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –Ø–Ω–¥–µ–∫—Å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) */
        .oauth-btn {
            border: none;
            margin: 0;
            padding: 0;
            width: 100%;
            overflow: visible;
            background: transparent;
            color: inherit;
            font: inherit;
            line-height: normal;
            -webkit-font-smoothing: inherit;
            -moz-osx-font-smoothing: inherit;
            -webkit-appearance: none;
            cursor: pointer;
            transition: all 0.1s ease-out;
            border-radius: 8px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .oauth-btn:hover {
            opacity: 0.8;
        }

        .oauth-btn:active {
            opacity: 0.7;
            transform: scale(0.97);
        }

        .oauth-btn.vk {
            background: #0077ff;
            color: #ffffff;
        }

        .oauth-btn.yandex {
            background: #FC3F1D;
            color: #ffffff;
        }

        .oauth-btn-container {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            width: 100%;
            justify-content: center;
            gap: 10px;
        }

        .oauth-btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .oauth-btn-text {
            display: flex;
            font-family: -apple-system, system-ui, "Helvetica Neue", Roboto, sans-serif;
            font-weight: 500;
            font-size: 16px;
            color: inherit;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        .divider {
            text-align: center;
            margin: 30px 0;
            color: #999;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .divider::before {
            left: 0;
        }

        .divider::after {
            right: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>

        <div class="message" id="message"></div>

        <!-- –í—Ö–æ–¥ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É -->
        <div id="phone-tab" class="tab-content active">
            <div class="form-group">
                <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                <input type="tel" id="phone" placeholder="+7 (999) 123-45-67" value="+79277899017">
            </div>

            <div id="phone-code-section" style="display: none;">
                <div class="form-group">
                    <label for="phone-code">–ö–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</label>
                    <div class="code-input">
                        <input type="text" id="phone-code" placeholder="–ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –Ω–æ–º–µ—Ä–∞ –∑–≤–æ–Ω—è—â–µ–≥–æ" maxlength="4">
                        <button class="btn btn-secondary" onclick="sendPhoneCode()" id="send-phone-btn">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
                    </div>
                    <p class="hint">–í–∞–º –ø–æ—Å—Ç—É–ø–∏—Ç –∑–≤–æ–Ω–æ–∫. –ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –Ω–æ–º–µ—Ä–∞ –∑–≤–æ–Ω—è—â–µ–≥–æ - —ç—Ç–æ –≤–∞—à –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.</p>
                </div>
                <button class="btn" onclick="verifyPhoneCode()">–í–æ–π—Ç–∏</button>
            </div>

            <button class="btn" onclick="sendPhoneCode()" id="phone-send-btn">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
        </div>

        <div class="divider">–∏–ª–∏</div>

        <!-- OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
        <div class="oauth-buttons">
            <!-- VK ID OneTap –≤–∏–¥–∂–µ—Ç -->
            <div id="vk-id-widget"></div>
            
            <!-- –Ø–Ω–¥–µ–∫—Å ID –≤–∏–¥–∂–µ—Ç -->
            <div id="yandex-id-widget"></div>
        </div>
    </div>

    <!-- VK ID SDK -->
    <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
    
    <!-- –Ø–Ω–¥–µ–∫—Å ID SDK -->
    <script src="https://yastatic.net/s3/passport-sdk/autofill/v1/sdk-suggest-with-polyfills-latest.js"></script>

    <script>
        // API URL - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ nginx
        const API_URL = window.location.origin + '/api';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è OAuth (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ API)
        let VK_CLIENT_ID = null;
        let YANDEX_CLIENT_ID = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ API
        async function loadConfig() {
            try {
                const response = await fetch(`${API_URL}/config`);
                if (response.ok) {
                    const config = await response.json();
                    VK_CLIENT_ID = config.vk_client_id;
                    YANDEX_CLIENT_ID = config.yandex_client_id;
                    console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ .env:', { 
                        VK_CLIENT_ID: VK_CLIENT_ID ? '‚úì' : '‚úó', 
                        YANDEX_CLIENT_ID: YANDEX_CLIENT_ID ? '‚úì' : '‚úó' 
                    });
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', response.status);
                    const errorText = await response.text();
                    console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', errorText);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', error);
                showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API.', 'error');
            }
        }

        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 5000);
        }


        // –¢–µ–ª–µ—Ñ–æ–Ω
        async function sendPhoneCode() {
            const phone = document.getElementById('phone').value;
            if (!phone) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/send-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('–í–∞–º –ø–æ—Å—Ç—É–ø–∏—Ç –∑–≤–æ–Ω–æ–∫. –ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –Ω–æ–º–µ—Ä–∞ –∑–≤–æ–Ω—è—â–µ–≥–æ - —ç—Ç–æ –≤–∞—à –∫–æ–¥.', 'success');
                    document.getElementById('phone-code-section').style.display = 'block';
                    document.getElementById('phone-send-btn').style.display = 'none';
                } else {
                    showMessage(data.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–≤–æ–Ω–∫–∞', 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        async function verifyPhoneCode() {
            const phone = document.getElementById('phone').value;
            const code = document.getElementById('phone-code').value;

            if (!code) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/verify-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, code })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    localStorage.setItem('auth_token', data.token);
                    window.location.href = 'dashboard.html';
                } else {
                    showMessage(data.detail || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥', 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }


        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK ID SDK
        function initVKID() {
            const vkWidget = document.getElementById('vk-id-widget');
            
            if (!('VKIDSDK' in window)) {
                console.error('VK ID SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                vkWidget.innerHTML = '<p style="color: #666; font-size: 14px;">VK ID SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</p>';
                return;
            }

            if (!VK_CLIENT_ID) {
                vkWidget.innerHTML = '<p style="color: #856404; font-size: 14px; background: #fff3cd; padding: 12px; border-radius: 5px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...</p>';
                return;
            }

            const VKID = window.VKIDSDK;
            const redirectUrl = window.location.origin + '/tets/vk-token.html';
            const isLocalhost = window.location.hostname === 'localhost' || 
                                window.location.hostname === '127.0.0.1' ||
                                window.location.hostname.startsWith('192.168.') ||
                                window.location.hostname.startsWith('10.') ||
                                window.location.hostname.startsWith('172.');

            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É (–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –ø—Ä–∏ CORS –æ—à–∏–±–∫–∞—Ö –Ω–∞ localhost)
            const button = document.createElement('button');
            button.className = 'oauth-btn vk';
            button.innerHTML = `
                <div class="oauth-btn-container">
                    <div class="oauth-btn-icon">
                        <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M4.54648 4.54648C3 6.09295 3 8.58197 3 13.56V14.44C3 19.418 3 21.907 4.54648 23.4535C6.09295 25 8.58197 25 13.56 25H14.44C19.418 25 21.907 25 23.4535 23.4535C25 21.907 25 19.418 25 14.44V13.56C25 8.58197 25 6.09295 23.4535 4.54648C21.907 3 19.418 3 14.44 3H13.56C8.58197 3 6.09295 3 4.54648 4.54648ZM6.79999 10.15C6.91798 15.8728 9.92951 19.31 14.8932 19.31H15.1812V16.05C16.989 16.2332 18.3371 17.5682 18.8875 19.31H21.4939C20.7869 16.7044 18.9535 15.2604 17.8141 14.71C18.9526 14.0293 20.5641 12.3893 20.9436 10.15H18.5722C18.0747 11.971 16.5945 13.6233 15.1803 13.78V10.15H12.7711V16.5C11.305 16.1337 9.39237 14.3538 9.314 10.15H6.79999Z" fill="white"/>
                        </svg>
                    </div>
                    <div class="oauth-btn-text">–í–æ–π—Ç–∏ —Å VK ID</div>
                </div>
            `;
            
            button.onclick = function() {
                // –ï—Å–ª–∏ localhost, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback - –æ–±—ã—á–Ω—ã–π OAuth redirect
                if (isLocalhost) {
                    console.log('Localhost –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback - –æ–±—ã—á–Ω—ã–π OAuth redirect');
                    const redirectUri = encodeURIComponent(window.location.origin + '/tets/vk-token.html');
                    const scope = 'phone,email';
                    const authUrl = `https://oauth.vk.com/authorize?client_id=${VK_CLIENT_ID}&display=page&redirect_uri=${redirectUri}&scope=${scope}&response_type=token&v=5.131`;
                    console.log('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ VK OAuth:', authUrl);
                    window.location.href = authUrl;
                    return;
                }

                // –ù–∞ —Ä–µ–∞–ª—å–Ω–æ–º –¥–æ–º–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º VK ID SDK
                try {
                    VKID.Config.init({
                        app: VK_CLIENT_ID,
                        redirectUrl: redirectUrl,
                        responseMode: VKID.ConfigResponseMode.Callback,
                        source: VKID.ConfigSource.LOWCODE,
                        scope: 'phone email',
                    });

                    VKID.Auth.login({
                        uuid: 'uuid-' + Date.now(),
                        scope: 'phone email'
                    })
                    .then(function(data) {
                        if (data && data.code && data.device_id) {
                            VKID.Auth.exchangeCode(data.code, data.device_id)
                                .then(function(tokenData) {
                                    if (tokenData && tokenData.access_token) {
                                        sendOAuthToken('vk', tokenData.access_token);
                                    } else {
                                        showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω VK', 'error');
                                    }
                                })
                                .catch(function(error) {
                                    console.error('VK ID Exchange Error:', error);
                                    showMessage('–û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞ –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω VK', 'error');
                                });
                        } else if (data && data.access_token) {
                            sendOAuthToken('vk', data.access_token);
                        } else {
                            showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç VK', 'error');
                        }
                    })
                    .catch(function(error) {
                        console.error('VK ID Login Error:', error);
                        showMessage('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ VK: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                    });
                } catch (error) {
                    console.error('VK ID Init Error:', error);
                    showMessage('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ VK ID. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.', 'error');
                }
            };
            
            vkWidget.appendChild(button);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –Ω–∞ localhost
            if (isLocalhost) {
                const warning = document.createElement('p');
                warning.style.cssText = 'color: #856404; font-size: 12px; margin-top: 5px; background: #fff3cd; padding: 8px; border-radius: 5px;';
                warning.textContent = '‚ö†Ô∏è VK ID —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –¥–æ–º–µ–Ω–µ (–Ω–µ –Ω–∞ localhost)';
                vkWidget.appendChild(warning);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å ID SDK
        function initYandexID() {
            const yandexWidget = document.getElementById('yandex-id-widget');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É SDK
            if (typeof YaAuthSuggest === 'undefined') {
                console.error('Yandex ID SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                yandexWidget.innerHTML = '<p style="color: #666; font-size: 14px;">–Ø–Ω–¥–µ–∫—Å ID SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</p>';
                return;
            }

            if (!YANDEX_CLIENT_ID) {
                yandexWidget.innerHTML = '<p style="color: #856404; font-size: 14px; background: #fff3cd; padding: 12px; border-radius: 5px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...</p>';
                return;
            }

            const redirectUri = window.location.origin + '/tets/yandex-token.html';
            const tokenPageOrigin = window.location.origin;

            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å ID —Å CLIENT_ID:', YANDEX_CLIENT_ID);

            // –ù–µ —É–∫–∞–∑—ã–≤–∞–µ–º scope - –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–æ—Å—Ç—É–ø—ã –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            YaAuthSuggest.init(
                {
                    client_id: YANDEX_CLIENT_ID,
                    response_type: 'token',
                    redirect_uri: redirectUri
                    // scope –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ–º - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–æ—Å—Ç—É–ø—ã –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                },
                tokenPageOrigin
            )
            .then(({ handler }) => {
                console.log('–Ø–Ω–¥–µ–∫—Å ID –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Å–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É');
                // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –Ø–Ω–¥–µ–∫—Å ID
                const button = document.createElement('button');
                button.className = 'oauth-btn yandex';
                button.innerHTML = `
                    <div class="oauth-btn-container">
                        <div class="oauth-btn-icon">
                            <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="28" height="28" rx="6" fill="#FC3F1D"/>
                                <path d="M14 8L18 16H16L15 13.5H13L12 16H10L14 8ZM13.5 12H14.5L14 10.8L13.5 12Z" fill="white"/>
                            </svg>
                        </div>
                        <div class="oauth-btn-text">–í–æ–π—Ç–∏ —Å –Ø–Ω–¥–µ–∫—Å ID</div>
                    </div>
                `;
                button.onclick = function() {
                    console.log('–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –Ø–Ω–¥–µ–∫—Å ID');
                    handler()
                        .then(function(data) {
                            console.log('Yandex Auth Data:', data);
                            if (data && data.access_token) {
                                sendOAuthToken('yandex', data.access_token);
                            } else {
                                showMessage('–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç –Ø–Ω–¥–µ–∫—Å', 'error');
                            }
                        })
                        .catch(function(error) {
                            console.error('Yandex Auth Error:', error);
                            showMessage('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ø–Ω–¥–µ–∫—Å: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                        });
                };
                yandexWidget.appendChild(button);
            })
            .catch(function(error) {
                console.error('Yandex ID Init Error:', error);
                console.log('Error code:', error.code);
                console.log('Error status:', error.status);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ not_available, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback - –æ–±—ã—á–Ω—ã–π OAuth redirect
                if (error.code === 'not_available' || error.status === 'error') {
                    console.log('‚úÖ SDK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback - –æ–±—ã—á–Ω—ã–π OAuth redirect');
                    
                    // –û—á–∏—â–∞–µ–º –≤–∏–¥–∂–µ—Ç –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–Ω–æ–ø–∫–∏
                    yandexWidget.innerHTML = '';
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —Å –æ–±—ã—á–Ω—ã–º OAuth redirect
                    const button = document.createElement('button');
                    button.className = 'oauth-btn yandex';
                    button.innerHTML = `
                        <div class="oauth-btn-container">
                            <div class="oauth-btn-icon">
                                <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="28" height="28" rx="6" fill="#FC3F1D"/>
                                    <path d="M14 8L18 16H16L15 13.5H13L12 16H10L14 8ZM13.5 12H14.5L14 10.8L13.5 12Z" fill="white"/>
                                </svg>
                            </div>
                            <div class="oauth-btn-text">–í–æ–π—Ç–∏ —Å –Ø–Ω–¥–µ–∫—Å ID</div>
                        </div>
                    `;
                    button.onclick = function() {
                        console.log('–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –Ø–Ω–¥–µ–∫—Å ID (fallback)');
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π OAuth redirect (Implicit Flow)
                        // –ù–µ —É–∫–∞–∑—ã–≤–∞–µ–º scope - –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–æ—Å—Ç—É–ø—ã –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                        const redirectUri = encodeURIComponent(window.location.origin + '/tets/yandex-token.html');
                        const authUrl = `https://oauth.yandex.ru/authorize?response_type=token&client_id=${YANDEX_CLIENT_ID}&redirect_uri=${redirectUri}`;
                        console.log('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞:', authUrl);
                        window.location.href = authUrl;
                    };
                    yandexWidget.appendChild(button);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    const warning = document.createElement('p');
                    warning.style.cssText = 'color: #856404; font-size: 12px; margin-top: 5px; background: #fff3cd; padding: 8px; border-radius: 5px;';
                    warning.textContent = '‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π OAuth (SDK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ localhost)';
                    yandexWidget.appendChild(warning);
                    
                    console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –Ø–Ω–¥–µ–∫—Å ID —Å–æ–∑–¥–∞–Ω–∞ (fallback —Ä–µ–∂–∏–º)');
                } else {
                    let errorMessage = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ø–Ω–¥–µ–∫—Å ID';
                    if (error.message) {
                        errorMessage += ': ' + error.message;
                    }
                    yandexWidget.innerHTML = `<p style="color: #721c24; font-size: 14px; background: #f8d7da; padding: 12px; border-radius: 5px;">${errorMessage}</p>`;
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ postMessage –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –æ—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ø–Ω–¥–µ–∫—Å
        window.addEventListener('message', function(event) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º origin –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            if (event.origin !== window.location.origin) {
                return;
            }

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω –æ—Ç –Ø–Ω–¥–µ–∫—Å
            // –ú–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –æ—Ç SDK –∏–ª–∏ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ OAuth redirect
            if (event.data && event.data.access_token) {
                console.log('–ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω –æ—Ç –Ø–Ω–¥–µ–∫—Å —á–µ—Ä–µ–∑ postMessage');
                sendOAuthToken('yandex', event.data.access_token);
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏–∑ localStorage (–µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å —Å –æ–±—ã—á–Ω–æ–≥–æ OAuth redirect)
        window.addEventListener('load', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –æ—Ç –Ø–Ω–¥–µ–∫—Å
            const yandexToken = localStorage.getItem('yandex_oauth_token');
            if (yandexToken) {
                console.log('–ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω –æ—Ç –Ø–Ω–¥–µ–∫—Å –∏–∑ localStorage');
                sendOAuthToken('yandex', yandexToken);
                // –û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage
                localStorage.removeItem('yandex_oauth_token');
                localStorage.removeItem('yandex_oauth_token_type');
                localStorage.removeItem('yandex_oauth_expires_in');
                localStorage.removeItem('yandex_oauth_scope');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –æ—Ç VK
            const vkToken = localStorage.getItem('vk_oauth_token');
            if (vkToken) {
                console.log('–ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω –æ—Ç VK –∏–∑ localStorage');
                sendOAuthToken('vk', vkToken);
                // –û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ localStorage
                localStorage.removeItem('vk_oauth_token');
                localStorage.removeItem('vk_oauth_expires_in');
                localStorage.removeItem('vk_oauth_user_id');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏
                const vkError = localStorage.getItem('vk_oauth_error');
                if (vkError) {
                    const errorDescription = localStorage.getItem('vk_oauth_error_description');
                    showMessage('–û—à–∏–±–∫–∞ VK OAuth: ' + (errorDescription || vkError), 'error');
                    localStorage.removeItem('vk_oauth_error');
                    localStorage.removeItem('vk_oauth_error_description');
                }
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ OAuth —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥
        async function sendOAuthToken(provider, accessToken) {
            try {
                const response = await fetch(`${API_URL}/auth/oauth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: provider,
                        access_token: accessToken
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    localStorage.setItem('auth_token', data.token);
                    window.location.href = 'dashboard.html';
                } else {
                    showMessage(data.detail || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                }
            } catch (error) {
                showMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', async () => {
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ API
            await loadConfig();
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ SDK
            setTimeout(() => {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º VK ID (–ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤–Ω—É—Ç—Ä–∏)
                initVKID();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ø–Ω–¥–µ–∫—Å ID (–ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤–Ω—É—Ç—Ä–∏)
                initYandexID();
            }, 500); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ SDK
        });
    </script>
</body>
</html>

